<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - All Tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand">Admin Tasks</a>
        <form th:action="@{/logout}" method="post" class="d-inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-danger">Logout</button>
        </form>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <a href="/admin/dashboard" class="btn btn-secondary">‚Üê Back</a>
            <h3 class="mb-0">All User Tasks</h3>
        </div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal">+ Add Task</button>
    </div>

    <table class="table table-striped table-bordered shadow-sm bg-white">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>User</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="adminTaskTable"></tbody>
    </table>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Assign Task to User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign to user</label>
                        <select id="personSelect" class="form-select" required></select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Create</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const tbody = document.getElementById("adminTaskTable");
    const select = document.getElementById("personSelect");

    async function loadTasks() {
        const res = await fetch("/api/tasks");
        const data = await res.json();
        tbody.innerHTML = "";
        data.forEach(t => {
            tbody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${t.title}</td>
        <td>${t.description}</td>
        <td>
          <select class="form-select form-select-sm" onchange="changeStatus(${t.id}, this.value)" style="min-width: 150px;">
            <option value="TO_DO" ${t.status === 'TO_DO' ? 'selected' : ''}>TO_DO</option>
            <option value="IN_PROGRESS" ${t.status === 'IN_PROGRESS' ? 'selected' : ''}>IN_PROGRESS</option>
            <option value="DONE" ${t.status === 'DONE' ? 'selected' : ''}>DONE</option>
          </select>
        </td>
        <td>${t.creator}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteTask(${t.id})">Delete</button>
        </td>
      </tr>`;
        });
    }

    async function loadUsers() {
        const res = await fetch("/api/persons");
        const data = await res.json();
        select.innerHTML = `<option value="">Select user...</option>`;
        data.forEach(u => {
            select.innerHTML += `<option value="${u.id}">${u.firstName} ${u.lastName}</option>`;
        });
    }

    document.getElementById("taskForm").addEventListener("submit", async e => {
        e.preventDefault();
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const personId = document.getElementById("personSelect").value;

        await fetch("/api/tasks", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ title, description, personId })
        });

        document.getElementById("taskForm").reset();
        bootstrap.Modal.getInstance(document.getElementById("addTaskModal")).hide();
        loadTasks();
    });

    async function changeStatus(id, newStatus) {
        try {
            await fetch(`/api/tasks/${id}/status?status=${newStatus}`, { method: "PUT" });
            loadTasks();
        } catch (error) {
            console.error("Error updating status:", error);
            alert("Failed to update task status");
            loadTasks(); // Reload to revert the select value
        }
    }

    async function deleteTask(id) {
        if (confirm("Delete this task?")) {
            await fetch(`/api/tasks/${id}`, { method: "DELETE" });
            loadTasks();
        }
    }

    loadTasks();
    loadUsers();
</script>
</body>
</html>